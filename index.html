<!-- build time:Thu Sep 20 2018 19:40:46 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1"><link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.4.1",sidebar:{position:"left",width:350,display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="Great artist always hid themselves in their work."><meta property="og:type" content="website"><meta property="og:title" content="Winter Coderʕ•͓͡•͡ʔ"><meta property="og:url" content="https://peniridis.github.io/index.html"><meta property="og:site_name" content="Winter Coderʕ•͓͡•͡ʔ"><meta property="og:description" content="Great artist always hid themselves in their work."><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Winter Coderʕ•͓͡•͡ʔ"><meta name="twitter:description" content="Great artist always hid themselves in their work."><link rel="canonical" href="https://peniridis.github.io/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>Winter Coderʕ•͓͡•͡ʔ</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Winter Coderʕ•͓͡•͡ʔ</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Welcom to the jungle.</p></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home menu-item-active"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://peniridis.github.io/hexo-00-major.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="一打鹏"><meta itemprop="description" content="Great artist always hid themselves in their work."><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Winter Coderʕ•͓͡•͡ʔ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/hexo-00-major.html" itemprop="url">Hexo+NexT v6.4.1博客优化日志</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-19 19:54:58" itemprop="dateCreated datePublished" datetime="2018-09-19T19:54:58+08:00">2018-09-19</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-09-20 10:18:18" itemprop="dateModified" datetime="2018-09-20T10:18:18+08:00">2018-09-20</time></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">1k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">1 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>记录Hexo优化及主题NexT美化</p></blockquote><p>&lt;!-- more --&gt;</p><p>@toc</p><h2>主题插件</h2><h3>「盘古之白」</h3><blockquote><p>為什麼你們就是不能加個空格呢？ by <strong><a href="https://github.com/vinta/pangu.js" target="_blank" rel="noopener">pangu.js</a></strong></p></blockquote><p>「盤古之白」，它劈開了全形字和半形字之間的混沌。另有研究顯示，打字的時候不喜歡在中文和英文之間加空格的人，感情路都走得很辛苦，有七成的比例會在 34 歲的時候跟自己不愛的人結婚，而其餘三成的人最後只能把遺產留給自己的貓。畢竟愛情跟書寫都需要適時地留白。</p><p>與大家共勉之。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd themes/next</span><br><span class="line">$ git clone https://github.com/theme-next/theme-next-pangu.git source/lib/pangu</span><br></pre></td></tr></table></figure><p></p><p>_themes/next/_config.yaml_修改</p><p></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pangu Support</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/theme-next/theme-next-pangu</span></span><br><span class="line"><span class="comment"># For more information: https://github.com/vinta/pangu.js</span></span><br><span class="line"><span class="comment"># pangu: false</span></span><br><span class="line"><span class="attr">pangu:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p></p><h3>静态资源压缩</h3><p>常规的做法是使用<code>gulp</code>来进行压缩，<code>gulp</code>是<code>Node.js</code>下的自动构建工具，通过一列的task执行步骤进行自动流程化处理。</p><p>这里使用<code>hexo-neat</code>压缩插件，配置简单，可以自动完成静态资源的压缩</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-neat --save</span><br></pre></td></tr></table></figure><p></p><p>添加以下配置到站点配置文件<code>_config.yml</code>的末尾</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># hexo-neat</span><br><span class="line"># 博文压缩</span><br><span class="line">neat_enable: true</span><br><span class="line"># 压缩html</span><br><span class="line">neat_html:</span><br><span class="line">  enable: true</span><br><span class="line">  exclude:</span><br><span class="line"># 压缩css  </span><br><span class="line">neat_css:</span><br><span class="line">  enable: true</span><br><span class="line">  exclude:</span><br><span class="line">    - &apos;**/*.min.css&apos;</span><br><span class="line"># 压缩js</span><br><span class="line">neat_js:</span><br><span class="line">  enable: true</span><br><span class="line">  mangle: true</span><br><span class="line">  output:</span><br><span class="line">  compress:</span><br><span class="line">  exclude:</span><br><span class="line">    - &apos;**/*.min.js&apos;</span><br><span class="line">    - &apos;**/jquery.fancybox.pack.js&apos;</span><br><span class="line">    - &apos;**/index.js&apos;</span><br></pre></td></tr></table></figure><p></p></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://peniridis.github.io/hbase-001-data-model.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="一打鹏"><meta itemprop="description" content="Great artist always hid themselves in their work."><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Winter Coderʕ•͓͡•͡ʔ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/hbase-001-data-model.html" itemprop="url">Apache HBase ™ Reference Guide：Hbase官方指南3.0（一）「数据模型」</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-17 13:56:03" itemprop="dateCreated datePublished" datetime="2018-09-17T13:56:03+08:00">2018-09-17</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-09-20 10:40:44" itemprop="dateModified" datetime="2018-09-20T10:40:44+08:00">2018-09-20</time></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">13k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>校验Hbase官方指南文档<a href="https://hbase.apache.org/book.html" target="_blank" rel="noopener">Apache HBase ™ Reference Guide Version 3.0.0-SNAPSHOT</a></p></blockquote><blockquote><p>Data Model部分No.20到No.32小节</p></blockquote><p>&lt;!-- more --&gt;</p><p>@toc</p><h2>数据模型</h2><p>在HBase中，数据存储在具有行和列的表中。关系型数据库（RDBMS）中有相似的概念，这并不是有用的类比。不过，HBase可以被认为是一个多维度的数据映射存储。</p><p><strong>HBase Data Model Terminology Hbase（数据模型术语）</strong></p><ul><li>Table（表）</li></ul><p>HBase表由多行组成。</p><ul><li>Row（列）</li></ul><p>HBase中的一行由一个行键和一个或多个具有与之关联的值的列组成。行存储时，行按字母顺序排序。因此，行的key的设计就显得非常重要。数据的存储目标是相近的数据存储到一起。一个常用的行的key的格式是网站域名。如果你的行的key是域名，你应该将域名进行反转(org.apache.www, org.apache.mail, org.apache.jira)再存储。这样的话，所有Apache域名将会存储在一起，而不是基于子域名的首字母分散在各处。</p><ul><li>Column（列）</li></ul><p>HBase中的列包含用「:」(冒号)分隔开的列族和列的限定符。</p><ul><li>Column Family（列族）</li></ul><p>因为性能的原因，列族物理上包含一组列和它们的值。每一个列族拥有一系列的存储属性，例如值是否缓存在内存中，数据是否要压缩或者他的行key是否要加密等等。表格中的每一行拥有相同的列族，尽管一个给定的行可能没有存储任何数据在一个给定的列族中。</p><ul><li>Column Qualifier（列限定符）</li></ul><p>列的限定符是列族中数据的索引。例如给定了一个列族<code>content</code>，那么限定符可能是<code>content:html</code>，也可以是<code>content:pdf</code>。列族在创建表格时是确定的了，但是列的限定符是可变的，并且行之间可能有很大差异。</p><ul><li>Cell（单元）</li></ul><p>单元是由行、列族、列限定符、值和代表值版本的时间戳组成的。</p><ul><li>Timestamp（时间戳）</li></ul><p>时间戳是写在值旁边的一个用于区分值的版本的数据。默认情况下，时间戳表示的是当数据写入时RegionSever的时间点，但你也可以在写入数据时指定一个不同的时间戳。</p><h2>概念视图</h2><p>你可以读一下 Jim R写的<a href="http://jimbojw.com/wiki/index.php?title=Understanding_Hbase_and_BigTable" target="_blank" rel="noopener">Understanding HBase and BigTable</a> 博客来简单了解一下HBase的数据模型，另一个好的理解是Amandeep Khurana.的 <a href="http://0b4af6cdc2f0c5998459-c0245c5c937c5dedcca3f1764ecc9b2f.r43.cf2.rackcdn.com/9353-login1210_khurana.pdf" target="_blank" rel="noopener">Introduction to Basic Schema Design</a> 。</p><p>学习不同的方面的资料可能会帮助你更透彻地了解HBase的设计。所链接的文章覆盖本部分所讲的信息。</p><p>接下来的例子是 取自<a href="http://research.google.com/archive/bigtable.html" target="_blank" rel="noopener">BigTable</a> 中第二页中的例子，在此基础上做了些许的改变。一个名为webable的表格，表格中有两行（com.cnn.www 和 com.example.www）和三个列族（contents, anchor, 和 people）。在这个例子当中，第一行(com.cnn.www)中anchor包含两列（anchor:cssnsi.com, anchor:my.look.ca）和content包含一列（contents:html）。这个例子中com.cnn.www拥有5个版本而com.example.www有一个版本。contents:html列中包含给定网页的整个HTML。anchor限定符包含能够表示行的站点以及链接中文本。People列族表示跟站点有关的人。</p><blockquote><p>列名 按照所定义好的，一个列名的格式为列族名前缀加限定符。例如，列contents:html由列族contents和html限定符。冒号「:」用于将列族和列限定符分开。</p></blockquote><p>Table 6. Table <code>webtable</code></p><table><thead><tr><th>行键</th><th>时间戳</th><th>列族contents</th><th>列族anchor</th><th>列族people</th></tr></thead><tbody><tr><td>&quot;com.cnn.www&quot;</td><td>t9</td><td></td><td>anchor:cnnsi.com = &quot;CNN&quot;</td><td></td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t8</td><td></td><td>anchor:cnnsi.com = &quot;CNN&quot;</td><td></td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t6</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td><td></td><td></td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t5</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td><td></td><td></td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t3</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td><td></td><td></td></tr><tr><td>&quot;com.example.www&quot;</td><td>t5</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td><td></td><td>people:author = &quot;John Doe&quot;</td></tr></tbody></table><p>在HBase中，表格中的单元如果是空将不占用空间或者事实上不存在。这就使得HBase看起来“稀疏”。表格视图不是唯一方式来查看HBase中数据，甚至不是最精确的。下面的方式以多维度映射的方式来表达相同的信息。这只是一个说明示例的模型可能不是严格准确的。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;com.cnn.www&quot;: &#123;</span><br><span class="line">    contents: &#123;</span><br><span class="line">      t6: contents:html: &quot;&lt;html&gt;...&quot;</span><br><span class="line">      t5: contents:html: &quot;&lt;html&gt;...&quot;</span><br><span class="line">      t3: contents:html: &quot;&lt;html&gt;...&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    anchor: &#123;</span><br><span class="line">      t9: anchor:cnnsi.com = &quot;CNN&quot;</span><br><span class="line">      t8: anchor:my.look.ca = &quot;CNN.com&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    people: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &quot;com.example.www&quot;: &#123;</span><br><span class="line">    contents: &#123;</span><br><span class="line">      t5: contents:html: &quot;&lt;html&gt;...&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    anchor: &#123;&#125;</span><br><span class="line">    people: &#123;</span><br><span class="line">      t5: people:author: &quot;John Doe&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2>物理视图</h2><p>尽管在概念层次，表可能看起来是由一些列稀疏的行组成，但他们是通过列族来存储的。一个新建的限定符(column_family:column_qualifier)可以随时地添加到已存在的列族中。 <em>Table 7. 列族 <code>anchor</code></em></p><table><thead><tr><th>行键</th><th>时间戳</th><th style="text-align:center">列族anchor</th></tr></thead><tbody><tr><td>&quot;com.cnn.www&quot;</td><td>t9</td><td style="text-align:center">anchor:cnnsi.com = &quot;CNN&quot;</td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t8</td><td style="text-align:center">anchor:my.look.ca = &quot;CNN.com&quot;</td></tr></tbody></table><p><em>Table 8. 列族 <code>contents</code></em></p><table><thead><tr><th>行键</th><th>时间戳</th><th>列族contents</th></tr></thead><tbody><tr><td>&quot;com.cnn.www&quot;</td><td>t6</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t5</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td></tr><tr><td>&quot;com.cnn.www&quot;</td><td>t3</td><td>contents:html = &quot;&lt;html&gt;…​&quot;</td></tr></tbody></table><p>概念视图中的空单元实际上是没有进行存储的。因此对于返回时间戳为t8的<code>contents:html</code>的值的请求，结果为空。同样的，一个返回时间戳为t9的<code>anchor:my.look.ca</code>的值的请求，结果也为空。然而，如果没有指定时间戳的话，那么会返回特定列的最新值。对有多个版本的列，优先返回最新的值，因为时间戳是按照递减顺序存储的。因此对于一个返回<code>com.cnn.www</code>里面所有的列的值并且没有指定时间戳的请求，返回的结果会是时间戳为t6的<code>contents:html</code>的值、时间戳 t9的<code>anchor:cnnsi.com</code>的值和时间戳t8的 <code>anchor:my.look.ca</code> 。</p><p>关于Apache Hbase如何存储数据的内部细节，请查看 <a href="http://hbase.apache.org/book.html#regions.arch" target="_blank" rel="noopener">regions.arch</a>.</p><h2>命名空间</h2><p>命名空间是一个类似于关系型数据库系统中的数据库的逻辑上的表分组的概念。这个抽象的概念为即将到来的多租户相关特性奠定了基础：</p><ul><li>配额管理 (<a href="https://issues.apache.org/jira/browse/HBASE-8410" target="_blank" rel="noopener">HBASE-8410</a>) - 限制命名空间可以使用的资源量（即区域，表）。</li><li>命名空间安全管理 (<a href="https://issues.apache.org/jira/browse/HBASE-9206" target="_blank" rel="noopener">HBASE-9206</a>) - 为租户提供另一级别的安全管理。</li><li>区域服务器组 (<a href="https://issues.apache.org/jira/browse/HBASE-6721" target="_blank" rel="noopener">HBASE-6721</a>) - 可以将命名空间/表固定到RegionServers的子集上，从而保证粗略的隔离级别。</li></ul><h3>命名空间管理</h3><p>命名空间可以被创建、移除和修改。命名空间关系的指定是在创建表格通过指定一个完全限定表名的形式完成的：</p><p></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">namespace</span>&gt;</span>:<span class="tag">&lt;<span class="name">table</span> <span class="attr">qualifier</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p><em>Example 7. Examples</em></p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#Create a namespace</span><br><span class="line">create_namespace &apos;my_ns&apos;</span><br><span class="line"></span><br><span class="line">#create my_table in my_ns namespace</span><br><span class="line">create &apos;my_ns:my_table&apos;, &apos;fam&apos;</span><br><span class="line"></span><br><span class="line">#drop namespace</span><br><span class="line">drop_namespace &apos;my_ns&apos;</span><br><span class="line"></span><br><span class="line">#alter namespace</span><br><span class="line">alter_namespace &apos;my_ns&apos;, &#123;METHOD =&gt; &apos;set&apos;, &apos;PROPERTY_NAME&apos; =&gt; &apos;PROPERTY_VALUE&apos;&#125;</span><br></pre></td></tr></table></figure><p></p><h3>预定义命名空间</h3><p>有两种预定义的特殊的命名空间</p><ul><li>hbase – 系统命名空间, 用于包含HBase内部表</li><li>default – 没有明确指定命名空间的表将会自动落入这个命名空间</li></ul><p><em>Example 8. Examples</em></p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#namespace=foo and table qualifier=bar</span><br><span class="line">create &apos;foo:bar&apos;, &apos;fam&apos;</span><br><span class="line"></span><br><span class="line">#namespace=default and table qualifier=bar</span><br><span class="line">create &apos;bar&apos;, &apos;fam&apos;</span><br></pre></td></tr></table></figure><p></p><h2>表</h2><p>在Schema（模式）定义时预先声明表。</p><h2>行</h2><p>行键是未解释的字节。行是按照字典顺序进行排序的并且最小的排在前面。空的字节数据用来表示表格的命名空间的开头和结尾。</p><h2>列族</h2><p>列在HBase中是归入到列族里面的。一个列族的所有列成员都有相同的前缀。例如，列<code>courses:history</code>和<code>cources:math</code>是cources列族的成员，冒号用于将列族和列限定符分开。列族前缀必须由可打印输出的字符组成。列限定符可以由任意字节组成。列族必须在结构定义阶段预先声明好，而列则不需要在结构设计阶段预先定义，而是可以在表的创建和运行阶段动态生成。</p><p>物理上来说，所有的列族成员都是存储在文件系统。因为调试和存储参数都是在列族级别完成，建议所有的列族都要拥有相同的访问模式和大小特征。</p><h2>单元</h2><p>一个{row,column,version}完全指定了HBase的一个单元。单元内容是未解释的字节</p><h2>数据模型操作</h2><p>数据模型的四个主要操作是Get，Put，Scan和Delete。可以通过Table实例进行操作。</p><h3>Get</h3><p><a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Get.html" target="_blank" rel="noopener">Get</a> 返回指定行的属性 Gets 通过 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Table.html#get(org.apache.hadoop.hbase.client.Get)" target="_blank" rel="noopener">Table.get</a>.执行。</p><h3>Put</h3><p><a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Put.html" target="_blank" rel="noopener">Put</a> 操作是在行键不存在时添加新行或者行键已经存在时进行更新。 Puts 是通过 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Table.html#put(org.apache.hadoop.hbase.client.Put)" target="_blank" rel="noopener">Table.put</a> (写缓存) 或者<a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Table.html#batch(java.util.List,%20java.lang.Object%5B%5D)" target="_blank" rel="noopener">Table.batch</a> (没有写缓存)执行的。</p><h3>Scans</h3><p><a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Scan.html" target="_blank" rel="noopener">Scan</a> 允许为指定属性迭代多行。</p><p>下面是表格实例中Scan的例子。假设一个表格里面有&quot;row1&quot;, &quot;row2&quot;, &quot;row3&quot;，然后有另外一组行键为&quot;abc1&quot;, &quot;abc2&quot;,和&quot;abc3&quot;。下面的例子展示如何设置一个Scan实例来返回以“row”开头的行。</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CF = <span class="string">"cf"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] ATTR = <span class="string">"attr"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Table table = ...      <span class="comment">// instantiate a Table instance</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Scan scan = <span class="keyword">new</span> Scan();</span><br><span class="line"> </span><br><span class="line">scan.addColumn(CF, ATTR);</span><br><span class="line"> </span><br><span class="line">scan.setRowPrefixFilter(Bytes.toBytes(<span class="string">"row"</span>));</span><br><span class="line"> </span><br><span class="line">ResultScanner rs = table.getScanner(scan);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">for</span> (Result r = rs.next(); r != <span class="keyword">null</span>; r = rs.next()) &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// process result...</span></span><br><span class="line"> </span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> </span><br><span class="line">  rs.close();  <span class="comment">// always close the ResultScanner!</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>需要说明的是通常最简单的指定Scan的一个特定停止点的方法是使用<a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/filter/InclusiveStopFilter.html" target="_blank" rel="noopener">InclusiveStopFilter</a> 类。</p><h3>Delete</h3><p><a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Delete.html" target="_blank" rel="noopener">Delete</a> 操作是将一个行从表中移除. Deletes 通过 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Table.html#delete(org.apache.hadoop.hbase.client.Delete)" target="_blank" rel="noopener">Table.delete</a>执行。</p><p>HBase不会立刻对数据的进行操作（可以理解为不对数据执行删除操作），而是为死亡数据创建一个称为墓碑的标签。这个墓碑和死亡数据会在重要精简工作中被删除。</p><p>查看 <a href="http://hbase.apache.org/book.html#version.delete" target="_blank" rel="noopener">version.delete</a> 获取更多关于列的版本删除的信息，查看 <a href="http://hbase.apache.org/book.html#compaction" target="_blank" rel="noopener">compaction</a> 获取关于压缩工作的更多信息。</p><h2>版本</h2><p>A <em>{row, column, version}</em> 在HBase完全指定一个单元。理论上来说行和列都一样的单元的数量是无限的，因为单元的地址是通过版本这个维度来区分的。</p><p>行和列使用字节来表达，而版本是通过长整型来指定的。典型来说，这个长时间实例就像<code>java.util.Date.getTime()</code> 或者 System.currentTimeMillis()返回的一样，以毫秒为单位，返回当前时间和 <em>January 1, 1970 UTC的时间差</em> 。</p><p>HBase的版本维度以递减顺序存储，以致读取一个存储的文件时，返回的是最新版本的数据。</p><p>关于单元的版本有许多的困扰，尤其是：</p><ul><li>如果多个数据写到一个具有相同版本的单元里，只能获取到最后写入的那个</li><li>以非递增的版本顺序写入也是可以的。</li></ul><p>下面我们将描述HBase中版本维度是如何运作的。可以看 <a href="https://issues.apache.org/jira/browse/HBASE-2406" target="_blank" rel="noopener">HBASE-2406</a> 关于HBase版本的讨论。 <a href="http://outerthought.org/blog/417-ot.html" target="_blank" rel="noopener">Bending time in HBase</a> 是关于HBase的版本或者时间维度的好读物。它提供了比这里更多的关于版本的细节信息。正如这里写到的，这里提到的_覆盖存在的时间戳_的限制将不再存在。这部分只是Bruno Dumon所写的关于版本的基本大纲。</p><h3>指定版本的存储数量</h3><p>版本的最大存储数量是列结构的一个部分并且在表格创建时指定，或者通过<code>alter</code>命令行，或者通过 <code>HColumnDescriptor.DEFAULT_VERSIONS</code>来修改。HBase0.96之前，默认数量是3，HBase0.96之后改为1.</p><p><em>Example 13. 修改一个列族的最大版本数</em></p><blockquote><p>这个例子使用HBase Shell来修改列族 f1的最大版本数为5，你也可以使用 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/HColumnDescriptor.html" target="_blank" rel="noopener">HColumnDescriptor</a>来实现。</p></blockquote><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase&gt; alter ‘t1′, NAME =&gt; ‘f1′, VERSIONS =&gt; 5</span><br></pre></td></tr></table></figure><p></p><p><em>Example 14. 修改一个列族的最小版本数Modify</em></p><blockquote><p>你也可以通过指定最小半本书来存储列族。默认情况下，该值为零，意味着这个属性是禁用的。下面的例子是通过HBase Shell设置列族f1中的所有列的最小版本数为2。你也可以通过 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/HColumnDescriptor.html" target="_blank" rel="noopener">HColumnDescriptor</a>来实现。</p></blockquote><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase&gt; alter ‘t1′, NAME =&gt; ‘f1′, MIN_VERSIONS =&gt; 2</span><br></pre></td></tr></table></figure><p></p><p>从HBase0.98.2开始，你可以通过设定在_hbase-site.xml_中设置hbase.column.max.version属性为所有新建的列指定一个全局的默认的最大版本数。</p><h3>版本和HBase 操作</h3><p>在这部分我们来看一下版本维度在HBase的每个核心操作中的表现。</p><h4>Get/Scan</h4><p>Get是通过获取Scan的第一个数据来实现的。下面的讨论适用于 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Get.html" target="_blank" rel="noopener">Get</a> 和 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Scan.html" target="_blank" rel="noopener">Scans</a>.。</p><p>默认情况下，如果你没有指定明确的版本，当你执行一个Get操作时，那个版本为最大值的单元将被返回（可能是也可能不是最新写人的那个）。默认的行为可以通过下面方式来修改：</p><ul><li>返回不止一个版本 查看 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Get.html#setMaxVersions()" target="_blank" rel="noopener">Get.setMaxVersions()</a></li><li>返回最新版本以外的版本, 查看 <a href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/client/Get.html#setTimeRange(long,%20long)" target="_blank" rel="noopener">Get.setTimeRange()</a></li></ul><p>想要获得小于或等于固定值的最新版本，仅仅通过使用一个0到期望版本的范围和设置最大版本数为1就可以实现获得一个特定时间点的最新版本的记录。</p><h4>默认的Get 例子</h4><p>下面例子仅仅返回行的当前版本。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CF = <span class="string">"cf"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] ATTR = <span class="string">"attr"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">Get get = <span class="keyword">new</span> Get(Bytes.toBytes(<span class="string">"row1"</span>));</span><br><span class="line"> </span><br><span class="line">Result r = table.get(get);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">byte</span>[] b = r.getValue(CF, ATTR);  <span class="comment">// returns current version of value</span></span><br></pre></td></tr></table></figure><p></p><h4>Get版本的例</h4><p>下面是获得行的最新3个版本的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CF = <span class="string">"cf"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] ATTR = <span class="string">"attr"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">Get get = <span class="keyword">new</span> Get(Bytes.toBytes(<span class="string">"row1"</span>));</span><br><span class="line"> </span><br><span class="line">get.setMaxVersions(<span class="number">3</span>);  <span class="comment">// will return last 3 versions of row</span></span><br><span class="line"> </span><br><span class="line">Result r = table.get(get);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">byte</span>[] b = r.getValue(CF, ATTR);  <span class="comment">// returns current version of value</span></span><br><span class="line"> </span><br><span class="line">List&lt;KeyValue&gt; kv = r.getColumn(CF, ATTR);  <span class="comment">// returns all versions of this column</span></span><br></pre></td></tr></table></figure><p></p><h4>Put</h4><p>Put操作常常是以固定的时间戳来创建一个新单元。默认情况下，系统使用服务的 currentTimeMillis，但是你也可以为每一个列自己指定版本（长整型）。这就意味着你可以指定一个过去或者未来的时间点，或者不是时间格式的长整型。</p><p>为了覆盖已经存在的值，对和那个你想要覆盖的单元完全一样的row、column和version进行put操作。</p><p><em>隐式版本例子</em> 下面Put是以当前时间为版本的隐式操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CF = <span class="string">"cf"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] ATTR = <span class="string">"attr"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">Put put = <span class="keyword">new</span> Put(Bytes.toBytes(row));</span><br><span class="line"> </span><br><span class="line">put.add(CF, ATTR, Bytes.toBytes( data));</span><br><span class="line"> </span><br><span class="line">table.put(put);</span><br></pre></td></tr></table></figure><p></p><p><em>显示版本例子</em></p><p>下面的put是显示指定时间戳的操作。</p><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CF = <span class="string">"cf"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] ATTR = <span class="string">"attr"</span>.getBytes();</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line">Put put = <span class="keyword">new</span> Put( Bytes.toBytes(row));</span><br><span class="line"> </span><br><span class="line"><span class="keyword">long</span> explicitTimeInMs = <span class="number">555</span>;  <span class="comment">// just an example</span></span><br><span class="line"> </span><br><span class="line">put.add(CF, ATTR, explicitTimeInMs, Bytes.toBytes(data));</span><br><span class="line"> </span><br><span class="line">table.put(put);</span><br></pre></td></tr></table></figure><p></p><p>警告: 版本时间戳是HBase内部用来计算数据的存活时间的。它最好避免自己设置。最好是将时间戳作为行的单独属性或者作为key的一部分，或者两者都有。</p><h4>Delete</h4><p>There are three different types of internal delete markers. See Lars Hofhansl’s blog for discussion of his attempt adding another, <a href="http://hadoop-hbase.blogspot.com/2012/01/scanning-in-hbase.html" target="_blank" rel="noopener">Scanning in HBase: Prefix Delete Marker</a>.</p><p>有三种不同的删除类型。可以看看Lars Hofhansl所写的博客 <a href="http://hadoop-hbase.blogspot.com/2012/01/scanning-in-hbase.html" target="_blank" rel="noopener">Scanning in HBase: Prefix Delete Marker</a>.</p><ul><li>Delete:列的指定版本</li><li>Delete column:列的所有版本</li><li>Delete family:特定列族里面的所有列。</li></ul><p>当要删除整个行时，HBase将会在内部为每一个列族创建一个墓碑。</p><p>删除通过创建一个墓碑标签来工作的。例如，让我们来设想我们要删除一个行。为此你可指定一个版本，或者使用默认的currentTimeMillis 。这就是删除小于等于该版本的所有单元。HBase不会修改数据，例如删除操作将不会立刻删除满足删除条件的文件。相反的，称为墓碑的会被写入，用来掩饰被删除的数据。当HBase执行一个压缩操作，墓碑将会执行一个真正地删除死亡值和墓碑自己的删除操作。如果你的删除操作指定的版本大于目前所有的版本，那么可以认为是删除整个行的数据。</p><p>你可以在 <a href="http://comments.gmane.org/gmane.comp.java.hadoop.hbase.user/28421" target="_blank" rel="noopener">Put w/timestamp → Deleteall → Put w/ timestamp fails</a> 用户邮件列表中查看关于删除和版本之间的相互影响的有益信息。</p><p>keyvalue也可以到<a href="http://hbase.apache.org/book.html#keyvalue" target="_blank" rel="noopener">keyvalue</a> 查看更多关于内部KeyValue格式的信息。</p><p>删除标签会在下一次仓库压缩操作中被清理掉，除非为列族设置了 KEEP_DELETED_CELLS (查看 <a href="http://hbase.apache.org/book.html#cf.keep.deleted" target="_blank" rel="noopener">Keeping Deleted Cells</a>)。为了保证删除时间的可配置性，你可以通过在 <em>hbase-site.xml</em> 。中hbase.hstore.time.to.purge.deletes属性来设置TTL（生存时间）。如果 hbase.hstore.time.to.purge.deletes没有设置或者设置为0，所有的删除标签包括哪些墓碑都会在下一次精简操作中被干掉。此外，未来带有时间戳的删除标签将会保持到发生在hbase.hstore.time.to.purge.deletes加上代表标签的时间戳的时间和的下一次精简操作。</p><blockquote><p>This behavior represents a fix for an unexpected change that was introduced in HBase 0.94, and was fixed in <a href="https://issues.apache.org/jira/browse/HBASE-10118" target="_blank" rel="noopener">HBASE-10118</a>. The change has been backported to HBase 0.94 and newer branches.</p></blockquote><h3>Optional New Version and Delete behavior in HBase-2.0.0</h3><p>In <code>hbase-2.0.0</code>, the operator can specify an alternate version and delete treatment by setting the column descriptor property<code>NEW_VERSION_BEHAVIOR</code> to true (To set a property on a column family descriptor, you must first disable the table and then alter the column family descriptor; see <a href="https://hbase.apache.org/book.html#cf.keep.deleted" target="_blank" rel="noopener">Keeping Deleted Cells</a> for an example of editing an attribute on a column family descriptor).</p><p>The 'new version behavior', undoes the limitations listed below whereby a <code>Delete</code> ALWAYS overshadows a <code>Put</code> if at the same location — i.e. same row, column family, qualifier and timestamp — regardless of which arrived first. Version accounting is also changed as deleted versions are considered toward total version count. This is done to ensure results are not changed should a major compaction intercede. See <code>HBASE-15968</code> and linked issues for discussion.</p><p>Running with this new configuration currently costs; we factor the Cell MVCC on every compare so we burn more CPU. The slow down will depend. In testing we’ve seen between 0% and 25% degradation.</p><p>If replicating, it is advised that you run with the new serial replication feature (See <code>HBASE-9465</code>; the serial replication feature did NOT make it into <code>hbase-2.0.0</code> but should arrive in a subsequent hbase-2.x release) as now the order in which Mutations arrive is a factor.</p><h3>当前的局限性</h3><h4>Deletes mask Puts删除覆盖插入/更新</h4><p>删除操作覆盖插入/更新操作，即使put在delete之后执行的。可以查看 <a href="https://issues.apache.org/jira/browse/HBASE-2256" target="_blank" rel="noopener">HBASE-2256</a>. 还记得一个删除写入一个墓碑，只有当下一次精简操作发生时才会执行真正地删除操作。假设你执行了一个删除全部小于等于T的操作。在此之外又做了一个时间戳为T的put操作。这个put操作即使是发生在delete之后，也会被delete墓碑所覆盖。执行put的时候不会报错，不过当你执行一个get的时候会发现执行无效。你会在精简操作之后重新开始工作。如果你在put的使用的递增的版本，那么这些问题将不会出现。但如果你不在意时间，在执行delelte后立刻执行put的话，那么它们将有可能发生在同一时间点，这将会导致上述问题的出现。</p><h4>精简操作影响查询结果</h4><p>创建三个版本为t1,t2,t3的单元，并且设置最大版本数为2.所以当我们查询所有版本时，只会返回t2和t3。但是当你删除版本t2和t3的时候，版本t1会重新出现。显然，一旦重要精简工作运行之后，这样的行为就不会再出现。（查看 <a href="http://outerthought.org/blog/417-ot.html" target="_blank" rel="noopener">Bendingtime in HBase</a>.）</p><h2>排序次序</h2><p>HBase中所有的数据模型操作返回的数据都是经过排序的。首先是行排序，其次是列族，接着是列限定符，最后是时间戳（递减排序，左右最新的记录最先返回）</p><h2>列元数据</h2><p>所有列的元数据都存储在一个列族的内部KeyValue实例中。因此，HBsase不仅支持一行中有多列，而且支持行之间的列的差异多样化。跟踪列名是你的责任。</p><p>唯一获取一个列族的所有列的方法是处理所有的行。查看 <a href="http://hbase.apache.org/book.html#keyvalue" target="_blank" rel="noopener">keyvalue</a>获得更多关于HBase内部如何存储数据的信息。</p><h2>Joins</h2><p>HBase是否支持join是一个常见的问题，答案是没有，至少没办法像RDBMS那样支持（例如等价式join或者外部join）。正如本章节所阐述的，HBase中读取数据的操作是Get和Scan。</p><p>然而，这不意味着等价式join功能没办法在你的应用中实现，但是你必须自己实现。两种主要策略是将数据非结构化地写到HBase中，或者查找表格然后在应用中或者MapReduce代码中实现join操作（正如RDBMS所演示的，将根据表格的大小会有几种不同的策略，例如嵌套使循环和hash-join）。哪个是最好的方法？这将依赖于你想做什么，没有一种方案能够应对各种情况。</p><h2>ACID</h2><p>查看 <a href="http://hbase.apache.org/acid-semantics.html" target="_blank" rel="noopener">ACID Semantics</a>. Lars Hofhansl也写了一份报告 <a href="http://hadoop-hbase.blogspot.com/2012/03/acid-in-hbase.html" target="_blank" rel="noopener">ACID in HBase</a>.</p></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://peniridis.github.io/softexam-002-os.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="一打鹏"><meta itemprop="description" content="Great artist always hid themselves in their work."><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Winter Coderʕ•͓͡•͡ʔ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/softexam-002-os.html" itemprop="url">软考（二）：操作系统</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-16 15:50:13" itemprop="dateCreated datePublished" datetime="2018-09-16T15:50:13+08:00">2018-09-16</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-09-18 17:42:00" itemprop="dateModified" datetime="2018-09-18T17:42:00+08:00">2018-09-18</time></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">2.1k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">2 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>记录操作系统中知识点</p></blockquote><p>&lt;!-- more --&gt;</p><p>@toc</p><h2>考点</h2><ul><li>进程<ul><li>进程的基本概念以及状态变化</li><li>进程死锁</li><li>进程同步、复制，信号量，前趋图，PV原语</li></ul></li><li>存储</li><li>其他细节</li></ul><h2>进程</h2><p><img src="images/media/Xnip2018-09-16_16-06-33.jpg" alt="进程三态图"></p><ul><li>就绪状态：进程已得到运行所需资源，只等待CPU的调度便可运行；</li><li>运行状态：进程已得到运行所需资源，并且得到了CPU的调度；</li><li>等待状态：不具备运行条件、等待时机的状态。另：等待状态也称阻塞状态；</li></ul><p><img src="images/media/2485424044372465764.jpg" alt="进程五态图"></p><ul><li>挂起：把该进程从内存中搬到外存上。</li><li>激活：又叫唤醒或恢复，操作是一样的，只是叫法不一样而已，该操作是把外存上的某个进程弄到内存上。</li></ul><p>为什么要引入挂起和激活操作呢？</p><ol><li><p>用户的需要。用户调试一个程序的时候，运行该程序一多半了，但是，忽然发现该程序此时有Bug，用户想停下来修改，但是修改后，用户又不想从头开始运行该程序，此为一因。</p></li><li><p>操作系统的需要。操作系统管理着资源的分配，它无法忍受那些占着资源而不运行的程序，另外，这些进程也会妨碍系统的运行速度，此为一因。等等。</p></li></ol><h3>进程的死锁</h3><p>进程管理师操作系统的核心，但如果设计不当，就会出现死锁的问题。如果一个进程在等待一个不可能发生的事，则进程就死锁了。而如果一个或多个进程产生死锁，就会造成系统死锁</p><p>例如：系统有3个进程：A、B、C。这三个进程都需要5个系统资源。如果系统有13个资源，则不可能发生死锁。</p><h3>死锁发生的必要条件</h3><ul><li>互斥条件：即一个资源每次只能被一个进程使用，在操作系统中这是真实存在的情况。</li><li>保持和等待条件：有一个进程已经获得了一些资源，但因请求其他资源被阻塞时，对已获取的资源保持不放。</li><li>不剥夺条件：有些系统不可资源是不可剥夺的，当某个进程已获得这种资源后，系统不能强行收回，只能由进程使用完时自己释放。</li><li>环路等待条件：若干个进程形成环形链，每个都占用对方要申请的下一个资源。</li></ul><h3>解决死锁的策略</h3><ul><li>死锁预防：例如：要求用户申请资源时一起申请所需的全部资源，这就破坏了保持和等待条件；将资源分层，得到上一层资源后，才能够申请下一层资源，它破坏了环路等待条件。预防通常会降低系统的效率。</li><li>死锁避免：避免是指进程在每次申请资源时判断这些操作是否安全，典型算法是「银行家算法」。但这种算法会增加系统的开销。</li><li>死锁检测：</li><li>死锁解除</li></ul><h3>银行家算法</h3><p>著名的银行家算法，最早是由Dijkstra提出来的。它是一种最有代表性的避免死锁的算法。在避免死锁方法中允许进程动态地申请资源，但系资源分配之前，应先计算此次分配资源的安全性，若分配不会导致系统进入不安全状态，则分配，否则等待。</p><p>银行家算法最重要的就是判断是可用资源和仍需资源之间的关系，如果可用资源数大于人需资源数，那么我们认为这个进程就是可以执行的，也是安全的，反之，便是不安全的。所以重中之重的是找到各种资源数。</p><p>对进程的判断遵循以下步骤:</p><ol><li>计算系统开始时所有的资源数,即开始的可用资源数;</li><li>在仍需资源数和可用资源数中作比较,找到符合条件的进程,最后修改进程执行完毕时系统的可用资源数;</li><li>继续比较剩余进程和可用资源数,找到下边可以执行的进程;</li><li>依次类推;</li></ol><p>【例】假设系统中有3类互斥资源R1、R2、R3，可用资源分别是9、8、5,。在T0时刻系统中有P1、P2、P3、P4和P5五个进程，这些进程对资源的最大需求量和已分配资源数如下表所示，则进程如何执行是安全的。</p><p><img src="images/media/Xnip2018-09-16_17-05-26.jpg" alt=""></p><p>这里需要强调的是，无论题目中给出何种条件，我们只要找到以下信息便可从容应对各种变化：</p><p><img src="images/media/Xnip2018-09-16_17-06-22.jpg" alt=""> 【注】：</p><p>可用资源：表示相应的进程执行完毕（即释放该进程占用的资源）以后可用的资源，满足公式可用资源=可用资源+已分配资源，（因为已分配的资源将会在进程执行完毕以后释放，所以可用资源会不断增多，进程执行完毕便会全部释放）同时它也是下一个进程执行时可用的资源。</p><p>**需要说明的是根据进程执行情况的不同，每次填入表格中的可用资源也不会相同（因为每个进程分配的资源是有差异的），那么执行顺序也会有所差异，合理即可。</p><p>仍需资源：仍需资源数=最大需求量-已分配资源数，据此公式可以求得R1、R2、R3在不同的进程时仍需的资源数，如上表中所示。</p><p>按照之前所讲的步骤，实现如下：</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">R1已分配的总资源数为1+2+2+1+1=7</span><br><span class="line">R2已分配的总资源数为2+1+1+2+1=7</span><br><span class="line">R3已分配的总资源数为1+1+0+0+3=5</span><br><span class="line">则R1 R2 R3可用资源数分别为</span><br><span class="line">R1=9-7=2</span><br><span class="line">R2=8-7=1</span><br><span class="line">R3=5-5=0</span><br></pre></td></tr></table></figure><p></p><ol><li><p>开始有的资源数R1 R2R3分别为2、1、0,所以从仍需资源中查找(需要说明的是查找的时候以最少资源数作为限定条件能够较快地找出结果),只有P2进程符合条件,此时可用资源变为4、2、1；</p></li><li><p>接下来在在其余的进程中查找符合条件的进程,只能执行P4,此时可用资源变为5、4、1,以此类推,按照以上的步骤即可找到所有进程执行的顺序P2-&gt;P4-&gt;P5-&gt;P1-&gt;P3；</p></li></ol><p>以上便是有关银行家算法的计算过程。</p><h3>前趋图</h3><p>前趋图（Precedence Graph）是一个有向无循环图，记为DAG（Directed Acyclic Graph），用于描述进程之间执行的前后关系。途中的每个节点可用于描述一个程序段或进城，乃至一条语句；节点间的有向边则用于表示两个节点之间存在的偏序（Partial Order）或前驱关系（Precedence Relation）「→」</p><p>如果</p></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://peniridis.github.io/softexam-001-grammar.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="一打鹏"><meta itemprop="description" content="Great artist always hid themselves in their work."><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Winter Coderʕ•͓͡•͡ʔ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/softexam-001-grammar.html" itemprop="url">软考（一）：文法</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-15 20:33:06" itemprop="dateCreated datePublished" datetime="2018-09-15T20:33:06+08:00">2018-09-15</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-09-19 19:53:06" itemprop="dateModified" datetime="2018-09-19T19:53:06+08:00">2018-09-19</time></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">3.2k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">3 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>记录编译原理中文法的知识点 编译原理顾名思义就是处理高级语言，使之称为计算机能够识别的语言（低级语言）的原理。而文法呢？就是用来描述程序设计语言的方法。类似佛法,用来描述佛家的诵经禅道的规则的。</p></blockquote><p>&lt;!-- more --&gt; @toc</p><h2>概念</h2><p>正如英语是由句子组成的集合，而句子又是由单词和标点符号组成的序列那样。程序设计语言 C 语言，是由 C 程序所组成的集合，而程序是由类似 if , begin, end 的符号，字母和数字这样一些基本符号所组成。</p><p>从字面上看，每个程序都是一个“基本符号”串，设有一基本符号串，那么 C 语言可看成是在这个基本符号集上定义的，按一定规则构成的一切基本符号串组成的集合。</p><p>通俗的讲就是：根据一些指定的规则，来确定编程语言的语法，从而实现编译器的功能。</p><h2>终结符和非终结符</h2><p>文法是由非终结符（大写字母）和终结符（小写字母）以及“—&gt;”组成的。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A—&gt; a</span><br><span class="line">B—&gt;dba</span><br><span class="line">S—&gt; Ab</span><br><span class="line">adB—&gt;d</span><br></pre></td></tr></table></figure><p></p><p>通过上面的几个例子可以看出：非终结符A、B、S，一般是写在左边，而终结符a、dba、b，一般是写在右边的。当然习惯的写法是非终结符用S（Start）表示，写在左边，自然而然的小写的就在右边了，这样也便于我们记忆文法的表示方式。</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">G2[S]</span><br><span class="line">S-&gt;Ap</span><br><span class="line">S-&gt;Bq</span><br><span class="line">A-&gt;a</span><br><span class="line">A-&gt;cA</span><br><span class="line">B-&gt;b</span><br><span class="line">b-&gt;dB</span><br></pre></td></tr></table></figure><p></p><p>如上所示：在这个推导式的集合中，存在六个推导式。其中S、A、B为非终结符。a、b、c、d、q、p为终结符。终结符是原子不可分的。</p><h2>分类</h2><p>在1956年的春天，一个叫乔姆斯基(Chomsky)的人发明了上述文法，他觉得有些文法存在着相似的形式，于是他就给文法分了一下类。</p><p>首先有一个前提：设有一个组合G=(Vn,Vt,P,S)。其中Vn是非终结符的集合，Vt是终结符的集合，P是推导式的一个集合，S是开始符。就上面的例子来说，A、B、S是Vn，a、dba、b是Vt，整个的集合为P。</p><h3>0型文法</h3><p>这是最简单的一个文法。它比较宽容，没有那么多的限制条件。左边必须要包含这些元素或者元素组合中的至少一个非终结符，右边可以是这些元素的任意组合，这样就构成了0型文法。由于限制最少，所以见到的文法至少是一个0型文法。如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A-&gt;a</span><br></pre></td></tr></table></figure><p></p><h3>1型文法（上下文有关文法）</h3><p>1型文法也叫上下文有关文法，此文法对应于线性有界自动机。</p><p>它在0型文法的基础之上，只添加了一个要求：右边的长度&gt;=左边的长度（终结符或非终结符的个数）。A—&gt; a、B—&gt;dba则是1型文法，而adB—&gt;d不符合1型文法要求 注意这里有一个特殊的形式 S—&gt; ∑（∑表示空），也是一个1型文法。</p><h3>2型文法（上下文无关文法）</h3><p>2型文法也叫上下文有关文法，此文法对应于下推自动机自动机。</p><p>它在1型文法的基础上，有增加了一个要求：左边必须是非终结符（个数不限）。 如：AB—&gt;de 属于2型文法，而 Aa—&gt;DE则不是，因为Aa中含有a。</p><h3>3型文法（正规文法）</h3><p>3型文法也叫正规文法，它对应有限状态自动机。</p><p>它是在2型的基础上提出了要么一个非终结符推出一个终结符，要么一个非终结符推出一个终结符并且带一个非终结符。</p><p>A-&gt;a | aB（右线性）或 A-&gt;a | Ba（左线性）</p><p>而上面的左线性、右线性是相互独立的。如：A—&gt;b、A—&gt;bD这是3型文法</p><p>但是A—&gt;b、A—&gt;bD、A—&gt;Db则不是3型文法。从这里可以看出，对于3型文法，它不是左右线性的“组合”，要么都是右线性，要么都是左线性。</p><h3>三种文法关系</h3><p>$$ 3\text{型文法} \subset2\text{型文法} \subset1\text{型文法} \subset0\text{型文法} $$</p><h2>正规式</h2><table><thead><tr><th>item</th><th>文法产生式</th><th style="text-align:right">正规式</th></tr></thead><tbody><tr><td>规则1</td><td>$$A-&gt;xB,B-&gt;y$$</td><td style="text-align:right">$$A=xy$$</td></tr><tr><td>规则2</td><td>$$A-&gt;xA\vert y$$</td><td style="text-align:right">$$A=x^*y$$</td></tr><tr><td>规则3</td><td>$$A-&gt;x,A-&gt;y$$</td><td style="text-align:right">$$A=x\vert y$$</td></tr></tbody></table><h2>实例</h2><h3>实例1</h3><p>$$ A-&gt;\varepsilon|aB,B-&gt;Ab|a $$</p><blockquote><p>判断上面推导式中满足什么类型的文法</p></blockquote><p>首先要判断哪些是<strong>终结符和非终结符</strong>,简单来讲终结符就是终结的,最小的不可拆分的元素,而不是终结符的都是非终结符.这个应该是没有任何问题的,所以上题中,的非终结符就是AB,其他都是非终结符.而0型文法中,讲到只需要在p中至少有一个非终结符,也就是在推导式的左边至少存在一个非终结符就可以了.这样一来,我们看到在等式的左边,两个都是非终结符.肯定满足0型文法,下面就是1型文法了,1型文法是怎么规定的呢?在0型文法的基础上,推导式的<strong>左边的长度肯定小于或者等于右边的长度</strong>,题中p集合里面左边的长度都小于右边的长度,所以肯定符合1型文法;接下来就是看看是否满足2型文法了.2型文法是怎么来限定的呢？在1型文法的基础上，在推导式的<strong>左边每个都是非终结符</strong>，如题，每个推导式的左边都是非终结符，所以肯定是2型文法了；3型文法的意思就是2型文法的基础上，看看是否满足右线性或者左线性，我们将这个推导式分开来判断。A--&gt;a或者A---&gt;aB，第一个拆开的推导式是右线性，而B---&gt;A是左线性的，3型文法是怎么规定的呢？是符合<strong>左线性或者右线性</strong>。</p><h3>实例2</h3><p>$$ \begin{align*} &amp;\mbox{文法}: G: S-&gt;xSx | y\mbox{所识别的语言是}（）。\ &amp;A. xyx\ &amp;B. (xyz)^<em>\ &amp;C. x^<em>yx^</em>\ &amp;D. x^nyx^n(n\geq0)\ \end{align</em>} $$</p><p>解析：D。 $$S-&gt;xSx-&gt;xxSxx-&gt;x…S…x-&gt;x…y...x-&gt;x^nyx^n$$ 因为S-&gt;y，所以 n 可以为0，即 n 的范围为大于等于0。</p><h3>实例3</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">给定文法A-&gt;bA|ca,该文法的句子是：</span><br><span class="line">A. bba</span><br><span class="line">B. cab</span><br><span class="line">C. bca</span><br><span class="line">D. cba</span><br></pre></td></tr></table></figure><p></p><p>解析：C。A-&gt;bA-&gt;bca。第二次替换A的时候，使用候选式A-&gt;ca 即可。</p><h3>实例4</h3><p>$$ \begin{align*} &amp;\text{对于一下编号为①，②，③的正则式，正确的说法是___。}\ &amp;\begin{matrix} \text{①}(aa^<em>|ab)^b &amp; \text{②}(a|b)^b &amp; \text{③}((a|b)^</em>|aa)^b \ \qquad \ \end{matrix}\ &amp;\begin{matrix} A. \text{正则式①，②等价} &amp; \qquad &amp; B. \text{正则式①，③等价}\ C. \text{正则式②，③等价} &amp; \qquad &amp; D. \text{正则式①，②，③互不等价} \end{matrix} \end{align*} $$ 解析：C。①中任意个前始终有b，②中为任意个a或b，故①②不等价，③中包含②并且任意长度a和故b组成的串，aa限制条件不是必要条件故②③等价。</p><h3>实例5</h3><p>$$ \begin{align*} &amp;\text{语言}L={a^mb^n|m\geq0,n\geq1} \text{的正规表达式是_____。}\ &amp;\begin{matrix} A. a^<em>bb^</em> &amp; B. aa^<em>bb^</em> &amp; C. aa^<em>b^</em> &amp; D. a^<em>b^</em> \end{matrix} \end{align*} $$</p><p>解析：A。$a^*$ 代表若干个a包括零个a，$b^*b$表示至少一个b。 <span class="label default">default</span></p></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://peniridis.github.io/hello-world.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="一打鹏"><meta itemprop="description" content="Great artist always hid themselves in their work."><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Winter Coderʕ•͓͡•͡ʔ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/hello-world.html" itemprop="url">Hello World</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-15 15:59:01" itemprop="dateCreated datePublished" datetime="2018-09-15T15:59:01+08:00">2018-09-15</time></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">441</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">1 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>github + hexo + NexT</p></blockquote><p></p><div class="post-button text-center"><a class="btn" href="/hello-world.html#more" rel="contents">阅读全文 &raquo;</a></div></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://peniridis.github.io/python-001-scrapy-cluster.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="一打鹏"><meta itemprop="description" content="Great artist always hid themselves in their work."><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Winter Coderʕ•͓͡•͡ʔ"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/python-001-scrapy-cluster.html" itemprop="url">Scrapy-cluster分布式爬虫</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-09-10 20:45:21" itemprop="dateCreated datePublished" datetime="2018-09-10T20:45:21+08:00">2018-09-10</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-09-16 19:36:24" itemprop="dateModified" datetime="2018-09-16T19:36:24+08:00">2018-09-16</time></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">8.3k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">8 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>记录搭建scrapy-cluster以及管理工具scrapyd+spiderkeeper</p></blockquote><p>&lt;!-- more --&gt;</p><ul><li>基于Scrapy-cluster库的kafka-monitor可以实现分布式爬虫</li><li>Scrapyd+Spiderkeeper实现爬虫的可视化管理</li></ul><h2>环境</h2><table><thead><tr><th>IP</th><th>Role</th></tr></thead><tbody><tr><td>168.*.*.118</td><td>Scrapy-cluster,scrapyd,spiderkeeper</td></tr><tr><td>168.*.*.119</td><td>Scrapy-cluster,scrapyd,kafka,redis,zookeeper</td></tr></tbody></table><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/redhat-release </span><br><span class="line">CentOS Linux release 7.4.1708 (Core) </span><br><span class="line"># python -V</span><br><span class="line">Python 2.7.5</span><br><span class="line"># java -version</span><br><span class="line">openjdk version &quot;1.8.0_181&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_181-b13)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)</span><br></pre></td></tr></table></figure><p></p><h2>Zookeeper 单机配置</h2><ul><li>下载并配置</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</span><br><span class="line"># tar -zxvf zookeeper-3.4.13.tar.gz</span><br><span class="line"># cd zookeeper-3.4.13/conf</span><br><span class="line"># cp zoo_sample.cfg zoo.cfg</span><br><span class="line"># cd ..</span><br><span class="line"># PATH=/opt/zookeeper-3.4.13/bin:$PATH</span><br><span class="line"># echo &apos;export PATH=/opt/zookeeper-3.4.13/bin:$PATH&apos; &gt; /etc/profile.d/zoo.sh</span><br></pre></td></tr></table></figure><p></p><ul><li>单节点启动</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper-3.4.13/bin/../conf/zoo.cfg</span><br><span class="line">Error contacting service. It is probably not running.</span><br><span class="line"></span><br><span class="line"># zkServer.sh start</span><br></pre></td></tr></table></figure><p></p><h2>kafka 单机配置</h2><ul><li>下载</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># wget http://mirrors.hust.edu.cn/apache/kafka/2.0.0/kafka_2.12-2.0.0.tgz</span><br><span class="line"># tar -zxvf kafka_2.12-2.0.0.tgz</span><br><span class="line"># cd kafka_2.12-2.0.0/</span><br></pre></td></tr></table></figure><p></p><ul><li>配置</li></ul><p></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim config/server.properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Server Basics #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The id of the broker. This must be set to a unique integer for each broker.</span></span><br><span class="line">broker.id=0                     <span class="comment"># kafka的机器编号，</span></span><br><span class="line">host.name = 168.*.*.119         <span class="comment"># 绑定ip</span></span><br><span class="line">port=9092                        <span class="comment"># 默认端口9092，</span></span><br><span class="line"><span class="comment"># Switch to enable topic deletion or not, default value is false</span></span><br><span class="line">delete.topic.enable=<span class="literal">true</span></span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line">zookeeper.connect=localhost:2181</span><br></pre></td></tr></table></figure><p></p><ul><li>启动</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup bin/kafka-server-start.sh config/server.properties &amp;</span><br></pre></td></tr></table></figure><p></p><p>停止命令<code>bin/kafka-server-stop.sh config/server.properties</code></p><h2>redis 单机配置</h2><ul><li>安装配置</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install redis</span><br><span class="line"># vim /etc/redis.conf</span><br><span class="line">bind 168.*.*.119</span><br></pre></td></tr></table></figure><p></p><ul><li>启动</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start redis.service</span><br></pre></td></tr></table></figure><p></p><h2>scrapy-cluster 单机配置</h2><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># git clone https://github.com/istresearch/scrapy-cluster.git</span><br><span class="line"># cd scrapy-cluster</span><br><span class="line"># pip install -r requirements.txt</span><br></pre></td></tr></table></figure><p></p><ul><li>离线运行单元测试,以确保一切似乎正常</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ./run_offline_tests.sh</span><br></pre></td></tr></table></figure><p></p><ul><li>修改配置</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vim kafka-monitor/settings.py</span><br><span class="line"># vim redis-monitor/settings.py</span><br><span class="line"># vim crawlers/crawling/settings.py</span><br></pre></td></tr></table></figure><p></p><ul><li>修改以下</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Redis host configuration</span><br><span class="line">REDIS_HOST = &apos;168.*.*.119&apos;</span><br><span class="line">REDIS_PORT = 6379</span><br><span class="line">REDIS_DB = 0</span><br><span class="line"></span><br><span class="line">KAFKA_HOSTS = &apos;168.*.*.119:9092&apos;</span><br><span class="line">KAFKA_TOPIC_PREFIX = &apos;demo&apos;</span><br><span class="line">KAFKA_CONN_TIMEOUT = 5</span><br><span class="line">KAFKA_APPID_TOPICS = False</span><br><span class="line">KAFKA_PRODUCER_BATCH_LINGER_MS = 25  # 25 ms before flush</span><br><span class="line">KAFKA_PRODUCER_BUFFER_BYTES = 4 * 1024 * 1024  # 4MB before blocking</span><br><span class="line"></span><br><span class="line"># Zookeeper Settings</span><br><span class="line">ZOOKEEPER_ASSIGN_PATH = &apos;/scrapy-cluster/crawler/&apos;</span><br><span class="line">ZOOKEEPER_ID = &apos;all&apos;</span><br><span class="line">ZOOKEEPER_HOSTS = &apos;168.*.*.119:2181&apos;</span><br></pre></td></tr></table></figure><p></p><ul><li>启动监听</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nohup python kafka_monitor.py run &gt;&gt; /root/scrapy-cluster/kafka-monitor/kafka_monitor.log 2&gt;&amp;1 &amp;</span><br><span class="line"># nohup python redis_monitor.py &gt;&gt; /root/scrapy-cluster/redis-monitor/redis_monitor.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p></p><h2>scrapyd 爬虫管理工具配置</h2><ul><li>安装</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># pip install scrapyd</span><br></pre></td></tr></table></figure><p></p><ul><li>配置</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># sudo mkdir /etc/scrapyd</span><br><span class="line"># sudo vi /etc/scrapyd/scrapyd.conf</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[scrapyd]</span><br><span class="line">eggs_dir    = eggs</span><br><span class="line">logs_dir    = logs</span><br><span class="line">items_dir   =</span><br><span class="line">jobs_to_keep = 5</span><br><span class="line">dbs_dir     = dbs</span><br><span class="line">max_proc    = 0</span><br><span class="line">max_proc_per_cpu = 10</span><br><span class="line">finished_to_keep = 100</span><br><span class="line">poll_interval = 5.0</span><br><span class="line">bind_address = 0.0.0.0</span><br><span class="line">http_port   = 6800</span><br><span class="line">debug       = off</span><br><span class="line">runner      = scrapyd.runner</span><br><span class="line">application = scrapyd.app.application</span><br><span class="line">launcher    = scrapyd.launcher.Launcher</span><br><span class="line">webroot     = scrapyd.website.Root</span><br><span class="line"></span><br><span class="line">[services]</span><br><span class="line">schedule.json     = scrapyd.webservice.Schedule</span><br><span class="line">cancel.json       = scrapyd.webservice.Cancel</span><br><span class="line">addversion.json   = scrapyd.webservice.AddVersion</span><br><span class="line">listprojects.json = scrapyd.webservice.ListProjects</span><br><span class="line">listversions.json = scrapyd.webservice.ListVersions</span><br><span class="line">listspiders.json  = scrapyd.webservice.ListSpiders</span><br><span class="line">delproject.json   = scrapyd.webservice.DeleteProject</span><br><span class="line">delversion.json   = scrapyd.webservice.DeleteVersion</span><br><span class="line">listjobs.json     = scrapyd.webservice.ListJobs</span><br><span class="line">daemonstatus.json = scrapyd.webservice.DaemonStatus</span><br></pre></td></tr></table></figure><p></p><ul><li>启动</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># nohup scrapyd &gt;&gt; /root/scrapy-cluster/scrapyd.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p></p><blockquote><p>建议做Nginx反向代理</p></blockquote><ul><li><strong><em>启动异常</em></strong></li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">File &quot;/usr/local/lib/python3.6/site-packages/scrapyd-1.2.0-py3.6.egg/scrapyd/app.py&quot;, line 2, in &lt;module&gt;</span><br><span class="line">from twisted.application.internet import TimerService, TCPServer</span><br><span class="line">File &quot;/usr/local/lib64/python3.6/site-packages/twisted/application/internet.py&quot;, line 54, in &lt;module&gt;</span><br><span class="line">from automat import MethodicalMachine</span><br><span class="line">File &quot;/usr/local/lib/python3.6/site-packages/automat/__init__.py&quot;, line 2, in &lt;module&gt;</span><br><span class="line">from ._methodical import MethodicalMachine</span><br><span class="line">File &quot;/usr/local/lib/python3.6/site-packages/automat/_methodical.py&quot;, line 210, in &lt;module&gt;</span><br><span class="line">    class MethodicalInput(object):</span><br><span class="line">File &quot;/usr/local/lib/python3.6/site-packages/automat/_methodical.py&quot;, line 220, in MethodicalInput</span><br><span class="line">    @argSpec.default</span><br><span class="line">builtins.TypeError: &apos;_Nothing&apos; object is not callable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Failed to load application: &apos;_Nothing&apos; object is not callable</span><br></pre></td></tr></table></figure><p></p><ul><li><strong><em>解决：Automat降级</em></strong></li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install Automat==0.6.0</span><br></pre></td></tr></table></figure><p></p><h2>Spiderkeeper 爬虫管理界面配置</h2><ul><li>安装</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install SpiderKeeper</span><br></pre></td></tr></table></figure><p></p><ul><li>启动</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/spiderkeeper/</span><br><span class="line">nohup spiderkeeper --server=http://168.*.*.118:6800 --username=admin --password=admin --database-url=sqlite:////root/spiderkeeper/SpiderKeeper.db &gt;&gt; /root/scrapy-cluster/spiderkeeper.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p></p><ul><li>浏览器访问http://168.<em>.</em>.118:5000</li></ul><h2>使用Spiderkeeper 管理爬虫</h2><h3>使用scrapyd-deploy部署爬虫项目</h3><ul><li>修改scrapy.cfg配置</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /root/scrapy-cluster/crawler/scrapy.cfg</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[settings]</span><br><span class="line">default = crawling.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line">url = http://168.*.*.118:6800/</span><br><span class="line">project = crawling</span><br></pre></td></tr></table></figure><p></p><ul><li>添加新的spider</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/scrapy-cluster/crawler/crawling/spider</span><br></pre></td></tr></table></figure><p></p><ul><li>使用scrapyd-deploy部署项目</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># cd /root/scrapy-cluster/crawler</span><br><span class="line"># scrapyd-deploy </span><br><span class="line">Packing version 1536225989</span><br><span class="line">Deploying to project &quot;crawling&quot; in http://168.*.*.118:6800/addversion.json</span><br><span class="line">Server response (200):</span><br><span class="line">&#123;&quot;status&quot;: &quot;ok&quot;, &quot;project&quot;: &quot;crawling&quot;, &quot;version&quot;: &quot;1536225989&quot;, &quot;spiders&quot;: 3, &quot;node_name&quot;: &quot;ambari&quot;&#125;</span><br></pre></td></tr></table></figure><p></p><h3>spiderkeeper 配置爬虫项目</h3><ul><li>登录Spiderkeeper创建项目</li></ul><p>使用scrapy.cfg中配置的项目名 <img src="media/15362341815397.jpg" alt=""> 创建后再Spiders-&gt;Dashboard中看到所有spider <img src="media/15362342524881.jpg" alt=""></p><h2>Scrapy-cluster 分布式爬虫</h2><p>Scrapy Cluster需要在不同的爬虫服务器之间进行协调，以确保最大的内容吞吐量，同时控制集群服务器爬取网站的速度。</p><p>Scrapy Cluster提供了两种主要策略来控制爬虫对不同域名的攻击速度。这由爬虫的类型与IP地址确定，但他们都作用于不同的域名队列。</p><p>Scrapy-cluster分布式爬虫，分发网址是基于IP地址。在不同的机器上启动集群，不同服务器上的每个爬虫去除队列中的所有链接。</p><h3>部署集群中第二个scrapy-cluster</h3><p>配置一台新的服务器参照[scrapy-cluster 单机配置](scrapy-cluster 单机配置),同时使用第一台服务器配置<code>kafka-monitor/settings.py</code> <code>redis-monitor/settings.py</code> <code>crawling/settings.py</code></p><h3>Current public ip 问题</h3><p>由于两台服务器同时部署在相同内网，spider运行后即获取相同<code>Current public ip</code>，导致scrapy-cluster调度器无法根据IP分发链接</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-09-07 16:08:29,684 [sc-crawler] DEBUG: Current public ip: b&apos;110.90.122.1&apos;</span><br></pre></td></tr></table></figure><p></p><p>参考代码<code>/root/scrapy-cluster/crawler/crawling/distributed_scheduler.py</code>第282行：</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    obj = urllib.request.urlopen(settings.get(<span class="string">'PUBLIC_IP_URL'</span>,</span><br><span class="line">                                  <span class="string">'http://ip.42.pl/raw'</span>))</span><br><span class="line">    results = self.ip_regex.findall(obj.read())</span><br><span class="line">    <span class="keyword">if</span> len(results) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># results[0] 获取IP地址即为110.90.122.1</span></span><br><span class="line">        self.my_ip = results[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">"Could not get valid IP Address"</span>)</span><br><span class="line">    obj.close()</span><br><span class="line">    self.logger.debug(<span class="string">"Current public ip: &#123;ip&#125;"</span>.format(ip=self.my_ip))</span><br><span class="line"><span class="keyword">except</span> IOError:</span><br><span class="line">    self.logger.error(<span class="string">"Could not reach out to get public ip"</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p></p><p>建议修改代码，获取本机IP</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.my_ip = [(s.connect((<span class="string">'8.8.8.8'</span>, <span class="number">53</span>)), s.getsockname()[<span class="number">0</span>], s.close()) </span><br><span class="line">                <span class="keyword">for</span> s <span class="keyword">in</span> [socket.socket(socket.AF_INET, socket.SOCK_DGRAM)]][<span class="number">0</span>][<span class="number">1</span>]</span><br></pre></td></tr></table></figure><p></p><h3>运行分布式爬虫</h3><p>在两个scrapy-cluster中运行相同Spider</p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execute([<span class="string">'scrapy'</span>, <span class="string">'runspider'</span>, <span class="string">'crawling/spiders/link_spider.py'</span>])</span><br></pre></td></tr></table></figure><p></p><p>使用<code>python kafka_monitor.py feed</code>投递多个链接，使用DEBUG即可观察到链接分配情况</p><h2>使用SpiderKeeper管理分布式爬虫</h2><h3>配置scrapyd管理集群第二个scrapy-cluster</h3><p>在第二台scrapy-cluster服务器上安装配置scrapyd，参考[scrapyd 爬虫管理工具配置](scrapyd 爬虫管理工具配置)并修改配置</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[settings]</span><br><span class="line">default = crawling.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line">url = http://168.*.*.119:6800/</span><br><span class="line">project = crawling</span><br></pre></td></tr></table></figure><p></p><p>启动scrapyd后使用scrapyd-deploy工具部署两个scrapy-cluster上的爬虫项目。</p><h3>使用Spiderkeeper连接多个scrapy-cluster</h3><ul><li>重新启动spiderkeeper，对接两个scrapy-cluster的管理工具scrapyd。</li></ul><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup spiderkeeper --server=http://168.*.*.118:6800 --server=http://168.*.*.119:6800 --username=admin --password=admin --database-url=sqlite:////root/spiderkeeper/SpiderKeeper.db &gt;&gt; /root/scrapy-cluster/spiderkeeper.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p></p><blockquote><p>注意：要使用spiderkeeper管理同一个集群，爬虫项目名称必须一致，同时集群中scrapy-cluster配置相同spider任务</p></blockquote><ul><li>浏览器访问http://168.<em>.</em>.118:5000 启动爬虫时即可看见两个scrapy-cluster集群配置，启动同名爬虫开始scrapy-cluster分布式爬虫 <img src="images/media/15363140725100.jpg" alt=""></li><li>启动分布式爬虫后状态 <img src="images/media/15363142039648.jpg" alt=""></li></ul></div><div></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">一打鹏</p><p class="site-description motion-element" itemprop="description">Great artist always hid themselves in their work.</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">9</span> <span class="site-state-item-name">标签</span></div></nav></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">一打鹏</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">28k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">25 分钟</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div><span class="post-meta-divider">|</span><div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.1</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.ui.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });</script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/lib/pangu/dist/pangu.min.js?v=3.3"></script><script type="text/javascript">pangu.spacingPage()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script></body></html><!-- rebuild by neat -->